# Project 3: Automating Malware Analysis with Yara and Python

## Introduction
This project will guide you through automating malware analysis using Yara and Python. You will learn how to write Python scripts to automate the scanning of files with Yara rules, analyze the results, and generate reports. This hands-on experience will enhance your ability to efficiently analyze large volumes of files for potential malware.

## Lab Setup and Tools
- A system with Linux
- Yara installed
- Python 3 installed
- A collection of known malware samples (for educational purposes)
- A collection of benign files for testing

## Tool Installation

### Install Yara
#### On Linux (Debian-based):
```bash
sudo apt-get update
sudo apt-get install yara
```
####  Install Python 3

Python 3 usually comes pre-installed on most Linux distributions. Verify the installation:

```bash
python3 --version
```

### Install Yara-Python
Yara-Python is a Python library that allows you to use Yara from your Python scripts.

```bash
pip3 install yara-python
```

## Exercises
### Exercise 1: Writing a Basic Yara-Python Script
**Steps**:

1. Create a new Python script named yara_scan.py.
2. Write a script to load a Yara rule and scan a file:
```python
import yara

# Define a Yara rule
rule = """
rule ExampleRule {
    strings:
        $my_text_string = "malicious_string"
    condition:
        $my_text_string
}
"""

# Compile the Yara rule
compiled_rule = yara.compile(source=rule)

# Scan a file
matches = compiled_rule.match('/path/to/file/to/scan')

# Print the matches
for match in matches:
    print(match)
```
**Expected Output**:

- The script prints out any matches found in the scanned file.

### Exercise 2: Scanning Multiple Files
**Steps**:

1. Modify yara_scan.py to scan multiple files in a directory.
```python
import yara
import os

# Define a Yara rule
rule = """
rule ExampleRule {
    strings:
        $my_text_string = "malicious_string"
    condition:
        $my_text_string
}
"""

# Compile the Yara rule
compiled_rule = yara.compile(source=rule)

# Directory to scan
directory_to_scan = '/path/to/directory'

# Scan all files in the directory
for root, dirs, files in os.walk(directory_to_scan):
    for file in files:
        file_path = os.path.join(root, file)
        matches = compiled_rule.match(file_path)
        if matches:
            print(f'Matches found in {file_path}:')
            for match in matches:
                print(match)
```

**Expected Output**:

The script prints out matches found in all files within the specified directory.

### Exercise 3: Generating a Report
**Steps**:

1. Modify yara_scan.py to generate a report of the scan results.
```python
import yara
import os
import json

# Define a Yara rule
rule = """
rule ExampleRule {
    strings:
        $my_text_string = "malicious_string"
    condition:
        $my_text_string
}
"""

# Compile the Yara rule
compiled_rule = yara.compile(source=rule)

# Directory to scan
directory_to_scan = '/path/to/directory'

# Dictionary to store scan results
results = {}

# Scan all files in the directory
for root, dirs, files in os.walk(directory_to_scan):
    for file in files:
        file_path = os.path.join(root, file)
        matches = compiled_rule.match(file_path)
        if matches:
            results[file_path] = [str(match) for match in matches]

# Write results to a JSON report
with open('scan_report.json', 'w') as report_file:
    json.dump(results, report_file, indent=4)
```
**Expected Output**:

- A scan_report.json file containing the scan results.

### Exercise 4: Enhancing the Script with Multiple Rules
**Steps**:

1. Modify yara_scan.py to use multiple Yara rules.
```python
import yara
import os
import json

# Define multiple Yara rules
rules = """
rule Rule1 {
    strings:
        $a = "malicious_string1"
    condition:
        $a
}
rule Rule2 {
    strings:
        $b = "malicious_string2"
    condition:
        $b
}
"""

# Compile the Yara rules
compiled_rules = yara.compile(source=rules)

# Directory to scan
directory_to_scan = '/path/to/directory'

# Dictionary to store scan results
results = {}

# Scan all files in the directory
for root, dirs, files in os.walk(directory_to_scan):
    for file in files:
        file_path = os.path.join(root, file)
        matches = compiled_rules.match(file_path)
        if matches:
            results[file_path] = [str(match) for match in matches]

# Write results to a JSON report
with open('scan_report.json', 'w') as report_file:
    json.dump(results, report_file, indent=4)
```
**Expected Output**:

- The scan_report.json file now includes results from multiple Yara rules.

### Exercise 5: Automating Regular Scans
**Steps**:

1. Set up a cron job to run yara_scan.py at regular intervals.
```bash
crontab -e
```
2. Add the following line to run the script every day at midnight:
```bash
0 0 * * * /usr/bin/python3 /path/to/yara_scan.py
```
**Expected Output**:

- The script runs automatically at the specified intervals, and new scan reports are generated regularly.

## Conclusion

By completing this project, you will have gained hands-on experience in automating malware analysis using Yara and Python. This skill is crucial for efficiently analyzing large volumes of files for potential malware, enhancing your ability to detect and respond to security threats.
